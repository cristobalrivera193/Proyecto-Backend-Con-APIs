{% extends 'base.html' %}

{% block title %}Reporte de Pedidos{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4">Reporte de Pedidos</h1>


    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Desde</label>
                    <input type="date" name="desde" class="form-control" value="{{ desde }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Hasta</label>
                    <input type="date" name="hasta" class="form-control" value="{{ hasta }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Estado</label>
                    <select name="estado" class="form-select">
                        <option value="">Todos</option>
                        {% for value, label in estados_choices %}
                            <option value="{{ value }}" {% if estado == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Plataforma</label>
                    <select name="plataforma" class="form-select">
                        <option value="">Todas</option>
                        {% for value, label in plataformas_choices %}
                            <option value="{{ value }}" {% if plataforma == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12 text-center">
                    <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
                </div>
            </form>
        </div>
    </div>


    <div class="row mb-5">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Pedidos por Estado</h5>
                </div>
                <div class="card-body">
                    <canvas id="chartEstado"></canvas>
                </div>
            </div>
        </div>
    </div>


    <div class="row mb-5">
        <div class="col-lg-6 mx-auto">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Pedidos por Plataforma</h5>
                </div>
                <div class="card-body">
                    <canvas id="chartPlataforma"></canvas>
                </div>
            </div>
        </div>
    </div>


    <div class="row">
        <div class="col-lg-8 mx-auto">
            <h3 class="mb-3">Pedidos por Estado</h3>
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Estado</th>
                        <th>Cantidad</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in por_estado %}
                        <tr>
                            <td>{{ item.estado_pedido }}</td>
                            <td>{{ item.cantidad }}</td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="2" class="text-center">No hay datos con los filtros seleccionados</td></tr>
                    {% endfor %}
                </tbody>
            </table>

            <h3 class="mb-3 mt-5">Pedidos por Plataforma</h3>
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Plataforma</th>
                        <th>Cantidad</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in por_plataforma %}
                        <tr>
                            <td>{{ item.origen_pedido }}</td>
                            <td>{{ item.cantidad }}</td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="2" class="text-center">No hay datos</td></tr>
                    {% endfor %}
                </tbody>
            </table>

            <h3 class="mb-3 mt-5">Productos Más Solicitados</h3>
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in productos_solicitados %}
                        <tr>
                            <td>{{ item.producto_referencia__nombre|default:"Sin producto" }}</td>
                            <td>{{ item.cantidad }}</td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="2" class="text-center">No hay productos solicitados</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="text-center mt-5 mb-5">
        <a href="{% url 'catalogo' %}" class="btn btn-outline-secondary btn-lg">Volver al Catálogo</a>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

  const ctxEstado = document.getElementById('chartEstado').getContext('2d');
  new Chart(ctxEstado, {
    type: 'bar',
    data: {
      labels: {{ labels_estado|safe }},
      datasets: [{
        label: 'Cantidad de Pedidos',
        data: {{ data_estado|safe }},
        backgroundColor: 'rgba(54, 162, 235, 0.6)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,  
        y: { beginAtZero: true }
      }
    }
  });


  const ctxPlataforma = document.getElementById('chartPlataforma').getContext('2d');
  new Chart(ctxPlataforma, {
    type: 'pie',
    data: {
      labels: {{ labels_plataforma|safe }},
      datasets: [{
        label: 'Cantidad de Pedidos',
        data: {{ data_plataforma|safe }},
        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
        borderColor: '#fff',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right' }
      }
    }
  });
</script>
{% endblock %}